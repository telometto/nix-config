name: Infrastructure Health Check
on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * *" # Daily at 6 AM

permissions:
  contents: read
  issues: write
jobs:
  build-hosts:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        host: [snowfall, blizzard, avalanche, kaizer]
    steps:
      - name: Access private repository
        uses: webfactory/ssh-agent@master
        with:
          ssh-private-key: ${{ secrets.GH_ACTIONS }}

      - name: Checkout main repository
        uses: actions/checkout@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Maximize disk space
        run: |
          HOST="${{ matrix.host }}"
          echo "## ðŸ“¦ Disk Usage (${HOST}) - before cleanup" >> $GITHUB_STEP_SUMMARY
          df -h >> $GITHUB_STEP_SUMMARY

          # Aggressive cleanup for runner disk space
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /opt/hostedtoolcache || true
          sudo rm -rf /home/linuxbrew || true
          sudo rm -rf /usr/local/share/boost || true
          sudo rm -rf /usr/local/graalvm || true
          sudo rm -rf /usr/local/share/chromium || true
          sudo rm -rf /usr/local/.ghcup || true
          sudo rm -rf /usr/share/swift || true
          sudo rm -rf /usr/local/julia* || true
          sudo rm -rf /opt/az || true
          sudo rm -rf /opt/microsoft || true
          sudo rm -rf /opt/pipx || true
          sudo rm -rf /opt/google || true
          sudo rm -rf /usr/lib/google-cloud-sdk || true
          sudo rm -rf /usr/lib/jvm || true
          sudo rm -rf /usr/share/miniconda || true
          sudo rm -rf /usr/share/az_* || true
          sudo rm -rf /usr/share/gradle-* || true
          sudo rm -rf /usr/share/sbt || true
          sudo docker system prune -af || true
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true

          echo "## â™»ï¸ Disk Usage (${HOST}) - after cleanup" >> $GITHUB_STEP_SUMMARY
          df -h >> $GITHUB_STEP_SUMMARY

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Expand build sandbox for avalanche
        if: matrix.host == 'avalanche'
        run: |
          mkdir -p ~/.config/nix
          cat <<'EOF' >> ~/.config/nix/nix.conf
          sandbox = false
          EOF

      - name: Build ${{ matrix.host }}
        run: |
          HOST="${{ matrix.host }}"
          echo "## ðŸ—ï¸ Build Results - ${HOST}" >> $GITHUB_STEP_SUMMARY

          # Run GC before build to ensure max space
          nix-collect-garbage -d || true

          if nix build ".#nixosConfigurations.${HOST}.config.system.build.toplevel" --no-link --print-build-logs --max-jobs 2; then
            echo "âœ… ${HOST}: Build successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ${HOST}: Build failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Collect Nix garbage
        if: always()
        run: |
          nix store gc || nix-collect-garbage || true
          df -h

  health-summary:
    runs-on: ubuntu-latest
    needs: build-hosts
    if: always()
    steps:
      - name: Access private repository
        uses: webfactory/ssh-agent@master
        with:
          ssh-private-key: ${{ secrets.GH_ACTIONS }}

      - name: Checkout main repository
        uses: actions/checkout@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Check for security updates
        if: needs.build-hosts.result == 'success'
        run: |
          echo "## ðŸ”’ Security Status" >> $GITHUB_STEP_SUMMARY
          if nix run nixpkgs#vulnix -- --system; then
            echo "âœ… No known vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Potential security issues detected" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create issue if failures
        if: failure()
        uses: actions/github-script@main
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Infrastructure Health Check Failed',
              body: 'Automated health check detected issues. Please review the workflow run for details.',
              labels: ['infrastructure', 'urgent']
            })
