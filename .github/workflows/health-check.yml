name: Infrastructure Health Check
on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * *"

concurrency:
  group: health-check
  cancel-in-progress: false

permissions:
  contents: read
  issues: write

jobs:
  discover-hosts:
    runs-on: ubuntu-latest
    outputs:
      hosts: ${{ steps.hosts.outputs.matrix }}
    steps:
      - name: Checkout flake.nix
        uses: actions/checkout@v6.0.2
        with:
          sparse-checkout: flake.nix
          sparse-checkout-cone-mode: false

      - name: Extract host list
        id: hosts
        run: |
          hosts=$(grep -oP '^\s+\K\w+(?=\s*=\s*mkHost)' flake.nix)
          matrix=$(echo "$hosts" | jq -R . | jq -sc .)
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

  build-hosts:
    runs-on: ubuntu-latest
    needs: discover-hosts
    strategy:
      fail-fast: false
      matrix:
        host: ${{ fromJson(needs.discover-hosts.outputs.hosts) }}
    steps:
      - name: Access private repository
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_DEPLOY_KEY }}

      - name: Checkout main repository
        uses: actions/checkout@v6.0.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Maximize disk space
        run: |
          HOST="${{ matrix.host }}"
          echo "## ðŸ“¦ Disk Usage (${HOST}) - before cleanup" >> $GITHUB_STEP_SUMMARY
          df -h >> $GITHUB_STEP_SUMMARY

          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /opt/hostedtoolcache || true
          sudo rm -rf /home/linuxbrew || true
          sudo rm -rf /usr/local/share/boost || true
          sudo rm -rf /usr/local/graalvm || true
          sudo rm -rf /usr/local/share/chromium || true
          sudo rm -rf /usr/local/.ghcup || true
          sudo rm -rf /usr/share/swift || true
          sudo rm -rf /usr/local/julia* || true
          sudo rm -rf /opt/az || true
          sudo rm -rf /opt/microsoft || true
          sudo rm -rf /opt/pipx || true
          sudo rm -rf /opt/google || true
          sudo rm -rf /usr/lib/google-cloud-sdk || true
          sudo rm -rf /usr/lib/jvm || true
          sudo rm -rf /usr/share/miniconda || true
          sudo rm -rf /usr/share/az_* || true
          sudo rm -rf /usr/share/gradle-* || true
          sudo rm -rf /usr/share/sbt || true
          sudo docker system prune -af || true
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true

          echo "## â™»ï¸ Disk Usage (${HOST}) - after cleanup" >> $GITHUB_STEP_SUMMARY
          df -h >> $GITHUB_STEP_SUMMARY

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v13
        with:
          use-flakehub: false

      - name: Expand build sandbox for avalanche
        if: matrix.host == 'avalanche'
        run: |
          # avalanche uses features that require relaxed sandboxing
          mkdir -p ~/.config/nix
          cat <<'EOF' >> ~/.config/nix/nix.conf
          sandbox = false
          EOF

      - name: Build ${{ matrix.host }}
        run: |
          HOST="${{ matrix.host }}"
          echo "## ðŸ—ï¸ Build Results - ${HOST}" >> $GITHUB_STEP_SUMMARY

          nix-collect-garbage -d || true

          if nix build ".#nixosConfigurations.${HOST}.config.system.build.toplevel" --no-link --print-build-logs --max-jobs 2; then
            echo "âœ… ${HOST}: Build successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ${HOST}: Build failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Collect Nix garbage
        if: always()
        run: |
          nix store gc || nix-collect-garbage || true
          df -h

  health-summary:
    runs-on: ubuntu-latest
    needs: build-hosts
    if: always()
    steps:
      - name: Create issue if failures
        if: needs.build-hosts.result == 'failure'
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const title = 'ðŸš¨ Infrastructure Health Check Failed';

            const { data: issues } = await github.rest.issues.listForRepo({
              owner, repo,
              state: 'open',
              labels: 'infrastructure',
              creator: 'github-actions[bot]',
            });

            const existing = issues.find(i => i.title === title);
            const runUrl = `${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`;
            const body = `Automated health check detected build failures.\n\n**Workflow run:** ${runUrl}\n\nPlease review the workflow run for details.`;

            if (existing) {
              await github.rest.issues.createComment({
                owner, repo,
                issue_number: existing.number,
                body: `Build failure detected again.\n\n**Workflow run:** ${runUrl}`,
              });
            } else {
              await github.rest.issues.create({
                owner, repo, title, body,
                labels: ['infrastructure', 'urgent'],
              });
            }
