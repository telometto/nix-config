name: Security Audit
on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * 1"

concurrency:
  group: security-audit
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21

      - name: Check secrets exposure
        id: gitleaks
        run: |
          echo "## ðŸ” Security Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "### Secrets Scanning" >> $GITHUB_STEP_SUMMARY

          if nix run nixpkgs#gitleaks -- detect --verbose; then
            echo "âœ… Gitleaks: No secrets detected" >> $GITHUB_STEP_SUMMARY
            echo "secrets_found=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸš¨ Gitleaks: Potential secrets found" >> $GITHUB_STEP_SUMMARY
            echo "secrets_found=true" >> $GITHUB_OUTPUT
          fi

      - name: Audit firewall configuration
        run: |
          echo "### Firewall Configuration Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          open_ports=$(find . -name "*.nix" -exec grep -l "openFirewall.*true" {} \; 2>/dev/null || true)
          if [ -n "$open_ports" ]; then
            echo "**Files with opened firewall ports:**" >> $GITHUB_STEP_SUMMARY
            echo "$open_ports" | while read file; do
              echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "âœ… No explicitly opened firewall ports found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Audit SSH configuration
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### SSH Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if grep -Erq "services\.openssh\.settings\.PasswordAuthentication\s*=\s*true|PasswordAuthentication\s*=\s*true" --include="*.nix" . 2>/dev/null; then
            echo "âš ï¸ Password authentication is enabled in some configurations" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Password authentication not explicitly enabled" >> $GITHUB_STEP_SUMMARY
          fi

          if grep -Erq "services\.openssh\.settings\.PermitRootLogin\s*=\s*\"yes\"|PermitRootLogin\s*=\s*\"yes\"" --include="*.nix" . 2>/dev/null; then
            echo "âš ï¸ Root login is permitted in some configurations" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Root login not explicitly permitted" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Audit user permissions
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### User Permissions Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          wheel_users=$(grep -r "extraGroups.*wheel" --include="*.nix" . 2>/dev/null || true)
          if [ -n "$wheel_users" ]; then
            echo "**Users with sudo access (wheel group):**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$wheel_users" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Generate security report
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Security Summary" >> $GITHUB_STEP_SUMMARY
          echo "Audit completed at: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "Repository: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY

      - name: Create issue if secrets found
        if: steps.gitleaks.outputs.secrets_found == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const title = 'ðŸš¨ Security Alert: Potential Secrets Detected';

            const { data: issues } = await github.rest.issues.listForRepo({
              owner, repo,
              state: 'open',
              labels: 'security',
              creator: 'github-actions[bot]',
            });

            const existing = issues.find(i => i.title === title);
            const runUrl = `${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`;
            const body = `The automated security audit has detected potential secrets in the codebase.\n\n**Workflow run:** ${runUrl}\n\nPlease review and rotate any exposed credentials immediately.`;

            if (existing) {
              await github.rest.issues.createComment({
                owner, repo,
                issue_number: existing.number,
                body: `Secrets detected again.\n\n**Workflow run:** ${runUrl}`,
              });
            } else {
              await github.rest.issues.create({
                owner, repo, title, body,
                labels: ['security', 'urgent'],
              });
            }
