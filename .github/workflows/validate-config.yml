name: Configuration Validation
on:
  workflow_dispatch:
  pull_request:
    branches: [main]
    paths:
      - "**.nix"
      - "flake.lock"
      - "treefmt.nix"
  push:
    branches: [main]
    paths:
      - "**.nix"
      - "flake.lock"
      - "treefmt.nix"

concurrency:
  group: validate-config-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  discover-hosts:
    runs-on: ubuntu-latest
    outputs:
      hosts: ${{ steps.hosts.outputs.matrix }}
    steps:
      - name: Checkout flake.nix
        uses: actions/checkout@v6.0.2
        with:
          sparse-checkout: flake.nix
          sparse-checkout-cone-mode: false

      - name: Extract host list
        id: hosts
        run: |
          hosts=$(grep -oP '^\s+\K\w+(?=\s*=\s*mkHost)' flake.nix)
          matrix=$(echo "$hosts" | jq -R . | jq -sc .)
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

  validate:
    runs-on: ubuntu-latest
    needs: discover-hosts
    strategy:
      matrix:
        host: ${{ fromJson(needs.discover-hosts.outputs.hosts) }}
      fail-fast: false

    steps:
      - name: Access private repository
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_DEPLOY_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v6.0.2

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v21

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v13

      - name: Evaluate configuration
        run: |
          echo "## ðŸ” Configuration Validation for ${{ matrix.host }}" >> $GITHUB_STEP_SUMMARY

          echo "Evaluating NixOS configuration for ${{ matrix.host }}..."
          if nix eval ".#nixosConfigurations.${{ matrix.host }}.config.system.build.toplevel" --raw 2>&1 | head -n 1; then
            echo "âœ… Configuration evaluation passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Configuration evaluation failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Validate home-manager configurations
        run: |
          echo "Validating Home Manager configurations for ${{ matrix.host }}..."
          if nix eval ".#nixosConfigurations.${{ matrix.host }}.config.home-manager.users" --apply 'users: builtins.attrNames users' 2>/dev/null; then
            echo "âœ… Home Manager configurations are valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No Home Manager configurations found or evaluation failed" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for evaluation warnings
        run: |
          echo "## âš ï¸ Evaluation Warnings" >> $GITHUB_STEP_SUMMARY
          nix eval ".#nixosConfigurations.${{ matrix.host }}.config.system.build.toplevel" --raw 2>&1 | grep -i warning || echo "âœ… No warnings found" | tee -a $GITHUB_STEP_SUMMARY
